---
title: "NiCE Network Analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

##data manipulation and reformatting
require(tidyverse) ##includes ggplot2, tidyr, dplyr, and others
#require(reshape2) #melt function
#require(magrittr)
#require(stringr)
#require(dplyr)
require(lubridate)

##data visualization
require(ggpmisc) ###sts_poly_eq
require(ggthemes) ##to change the look of graphs
require(cowplot) ##for plot_grid
require(ggrepel) ##for pretty labels
#library(circlize)
circos.par("track.height" = 0.4)
library(ggcorrplot)
library(GGally)
library(ggpubr) #for ggarrange() and stat_pvalue_manual
library(ellipse)
library(RColorBrewer)
#library(PNWColors)
library(corrplot)
#library(lmerTest)
#library(lme4)
#library(nlme)
library(corrr)
#library(vegan)
library(arcdiagram)
library(igraph)
library(ggraph) #extension of ggplot to graph networks

knitr::opts_chunk$set(echo = TRUE)

setwd("/Volumes/Backup_1/Marie/Thesis/Rwanda/Lab work/03_NiCE_Chip/final_data")
source("correlation_dataframes.R")
source("networks_and_statistics.R")
```


```{r}
#plot networks

ggraph(nice_1_graph) +
  geom_edge_link(aes(edge_alpha= abs(r), edge_width= abs(r), color=r)) +
  guides(edge_alpha="none", edge_width="none") +
  scale_edge_colour_gradientn(limits = c(0.75,1), colors=c("dodgerblue2", "firebrick2")) +
  geom_node_point(color="lightgrey", size=3) +
  geom_node_text(aes(label = name), repel=TRUE) +
  theme_graph() +
  labs(title="N Cycle Probe Co-Occurrence in Mid Dry Season")

ggraph(nice_2_graph) +
  geom_edge_link(aes(edge_alpha= abs(r), edge_width= abs(r), color=r)) +
  guides(edge_alpha="none", edge_width="none") +
  scale_edge_colour_gradientn(limits = c(0.75,1), colors=c("dodgerblue2", "firebrick2")) +
  geom_node_point(color="lightgrey", size=3) +
  geom_node_text(aes(label = name), repel=TRUE) +
  theme_graph() +
  labs(title="N Cycle Probe Co-Occurrence in Late Dry Season")

ggraph(nice_3_graph) +
  geom_edge_link(aes(edge_alpha= abs(r), edge_width= abs(r), color=r)) +
  guides(edge_alpha="none", edge_width="none") +
  scale_edge_colour_gradientn(limits = c(0.75,1), colors=c("dodgerblue2", "firebrick2")) +
  geom_node_point(color="lightgrey", size=3) +
  geom_node_text(aes(label = name), repel=TRUE) +
  theme_graph() +
  labs(title="N Cycle Probe Co-Occurrence in Early Rainy Season")

ggraph(nice_4_graph) +
  geom_edge_link(aes(edge_alpha= abs(r), edge_width= abs(r), color=r)) +
  guides(edge_alpha="none", edge_width="none") +
  scale_edge_colour_gradientn(limits = c(0.75,1), colors=c("dodgerblue2", "firebrick2")) +
  geom_node_point(color="lightgrey", size=3) +
  geom_node_text(aes(label = name), repel=TRUE) +
  theme_graph() +
  labs(title="N Cycle Probe Co-Occurrence in Early Rainy Season")

ggraph(nice_5_graph) +
  geom_edge_link(aes(edge_alpha= abs(r), edge_width= abs(r), color=r)) +
  guides(edge_alpha="none", edge_width="none") +
  scale_edge_colour_gradientn(limits = c(0.75,1), colors=c("dodgerblue2", "firebrick2")) +
  geom_node_point(color="lightgrey", size=3) +
  geom_node_text(aes(label = name), repel=TRUE) +
  theme_graph() +
  labs(title="N Cycle Probe Co-Occurrence in Late Rainy Season")

ggraph(nice_6_graph) +
  geom_edge_link(aes(edge_alpha= abs(r), edge_width= abs(r), color=r)) +
  guides(edge_alpha="none", edge_width="none") +
  scale_edge_colour_gradientn(limits = c(0.75,1), colors=c("dodgerblue2", "firebrick2")) +
  geom_node_point(color="lightgrey", size=3) +
  geom_node_text(aes(label = name), repel=TRUE) +
  theme_graph() +
  labs(title="N Cycle Probe Co-Occurrence in Late Rainy Season")

```


```{r}
#arc diagram

arcplot(edgelist_1)
arcplot(edgelist_5)
arcplot(edgelist_6)

```


```{r}

#graph intersections: which co-occurences are stable between timepoints
nice_1_3_int_graph <- intersection(nice_1_graph, nice_3_graph)
nice_2_4_int_graph <- intersection(nice_2_graph, nice_4_graph)
nice_1_5_int_graph <- intersection(nice_1_graph, nice_5_graph)
nice_2_6_int_graph <- intersection(nice_2_graph, nice_6_graph)
nice_3_5_int_graph <- intersection(nice_3_graph, nice_5_graph)
nice_4_6_int_graph <- intersection(nice_4_graph, nice_6_graph)
nice_all_int <- intersection(nice_1_graph, nice_2_graph, nice_3_graph, nice_4_graph,
                             nice_5_graph, nice_6_graph)

test <- get.edgelist(nice_3_5_int_graph)
test_labels = as.data.frame(get.vertex.attribute(nice_3_5_int_graph))
arcplot(test, ordering=test_labels)

ggraph(nice_all_int) +
  geom_edge_link() +
  guides(edge_alpha="none", edge_width="none") +
  scale_edge_colour_gradientn(limits = c(0.75,1), colors=c("dodgerblue2", "firebrick2")) +
  geom_node_point(color="lightgrey", size=3) +
  geom_node_text(aes(label = name), repel=TRUE) +
  theme_graph()

```



```{r}
#explore network properties and relationships

#visualize density; network-level over time
timepoint <- c("09-16-2020", "10-06-2020", "11-18-2020", "12-07-2020", "01-19-2021", "02-10-2021") #need to change to actual date
dens <- c(nice_1_dens, nice_2_dens, nice_3_dens, nice_4_dens, nice_5_dens, nice_6_dens)
growth <- c("anthesis", "early growth", "anthesis", "early growth","anthesis", "early growth")

both <- as.data.frame(cbind(timepoint, dens, growth)) %>%
  mutate(timepoint = mdy(timepoint),
         dens = as.double(dens))

ggplot(both, aes(timepoint, dens, color=growth)) +
  geom_point() +
  geom_smooth(method="loess", se=FALSE) +
  theme_classic() +
  ylab("Network Density") +
  xlab("Collection Date") +
  theme(legend.title = element_blank()) +
  ggtitle("Network Density by Timepoint and Forage Growth Stage")

  

```


Interesting finding: 
Decreasing number of strong correlations from dry season to rainy season, decreasing network density


```{r}

#filter correlations by signficance (cutoff: p<0.05)

```

Time-series network analysis:

1. Separate by timepoint (AND location?--location not sig) *
2. Calculate Spearman's correlation, cutoff at 0.75 and p<0.05 (?)*
3. Generate dissimilary matrix: 1-correlation coefficient (bioDist package), smaller distances represent stronger correlations *
4. Visualize dissimilarity matrix using MDS *
5. PERMANOVA (vegan) to test for differences in co-occurence patterns, TIMEPOINT as independent variable *
6. Network structure: primer pairs represent nodes, presence of co-occurence relationship based on correlation is represented by an edge -- generate for each timepoint *
*note that spearman's is rank-based correlation and does not require variables to fit normality assumptions, and may outperform Pearson's correlations
7. Construct consensus network based on p-value and whether the co-occurence relationship occured in all timepoints*
8. Produce networks using igraph/arcdiagram*
  -simplify with delete.vertices and simplify functions
  -graph.union.by.name()
9. Modules: defined as groups of highly connected groups that are poorly connected to others
  -edge.betweenness.community()
  -betweenness centrality method: designed for simple graphs
10. Look for intersections between networks from different timepoints*
  -graph.intersection.by.name()
  -determine if any co-occurrence relationships are consistent across timepoints
  
Other analysis:
1. Characterize differences in community composition between sites and timepoints*
  -PERMANOVA with Bray-Curtis dissimilarity, scale abundances to between 0 and 1 *
  -decostand() and adonis() from vegan package
  -NMDS plots to visualize differences in community composition*
2. RDA or CCA to determine relevant environmental factors in community composition 
  -are these the same factors that are most important in co-occurence as well?
  
Network Statistics:
1.normalized node degree: number of co-occurrence relationships that a microbe has in a network, 
normalized by total number of nodes (degree() in igraph)*
2. betweenness scores: number of paths through a focal microbial node, betweenness() in igraph
3.clustering coefficients (transitivity()) 

4. determine relationship between degree and betweenness:
  -linear/non-linear
5. Identify taxa that are highly connected and may represent keystones in timepoint
  -mixed models with degree as an independent variable, betweenness response variable with lme4
  -keystone taxa defined as those with highest predicted betweenness based on mixed models


https://github.com/adina/co-occurrence


